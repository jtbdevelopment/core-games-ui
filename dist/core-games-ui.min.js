!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi.interceptors",[]),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi",["coreGamesUi.config","coreGamesUi.interceptors","coreGamesUi.services","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.controllers","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreAdminCtrl",["$scope","$http","jtbPlayerService",function(e,n,a){function t(){n.get("/api/player/admin/playersCreated/"+d).then(function(e){c.playersCreated24hours=e.data}),n.get("/api/player/admin/playersCreated/"+f).then(function(e){c.playersCreated7days=e.data}),n.get("/api/player/admin/playersCreated/"+g).then(function(e){c.playersCreated30days=e.data})}function r(){n.get("/api/player/admin/playersLoggedIn/"+d).then(function(e){c.playersLastLogin24hours=e.data}),n.get("/api/player/admin/playersLoggedIn/"+f).then(function(e){c.playersLastLogin7days=e.data}),n.get("/api/player/admin/playersLoggedIn/"+g).then(function(e){c.playersLastLogin30days=e.data})}function i(){n.get("/api/player/admin/gamesSince/"+d).then(function(e){c.gamesLast24hours=e.data}),n.get("/api/player/admin/gamesSince/"+f).then(function(e){c.gamesLast7days=e.data}),n.get("/api/player/admin/gamesSince/"+g).then(function(e){c.gamesLast30days=e.data})}function o(e){c.totalItems=e.totalElements,c.numberOfPages=e.totalPages,c.players=e.content,c.currentPage=e.number+1}function s(){var e="?pageSize="+c.pageSize+"&page="+(c.currentPage-1)+"&like="+c.searchText;n.get("/api/player/admin/playersLike/"+e).then(function(e){o(e.data)})}var c=this;c.searchText="",c.pageSize=20,c.players=[],c.computeRevertFields=function(){c.revertEnabled=a.realPID()!==a.currentID(),c.revertText=c.revertEnabled?"You are simulating another player.":"You are yourself."},c.playerCount=0,c.gameCount=0,c.playersCreated24hours=0,c.playersCreated7days=0,c.playersCreated30days=0,c.playersLastLogin24hours=0,c.playersLastLogin7days=0,c.playersLastLogin30days=0,c.gamesLast24hours=0,c.gamesLast7days=0,c.gamesLast30days=0;var u=Math.floor((new Date).getTime()/1e3),l=86400,d=u-l,f=u-7*l,g=u-30*l;n.get("/api/player/admin/playerCount").then(function(e){c.playerCount=e.data}),n.get("/api/player/admin/gameCount").then(function(e){c.gameCount=e.data}),t(),r(),i(),c.refreshData=function(){c.players.slice(0),c.totalItems=0,c.numberOfPages=0,c.currentPage=1,s()},c.changePage=function(){s()},c.switchToPlayer=function(e){a.overridePID(e)},c.revertToNormal=function(){a.overridePID(a.realPID())},c.refreshData(),c.computeRevertFields(),e.$on("playerLoaded",function(){c.computeRevertFields()})}]),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var a=[];return angular.isArray(e)?e.forEach(function(e){for(var t=!1,r=Object.keys(n),i=0;i<r.length;i++){var o=r[i],s=n[o].toLowerCase();if(-1!==e[o].toString().toLowerCase().indexOf(s)){t=!0;break}}t&&a.push(e)}):a=e,a}}),angular.module("coreGamesUi.interceptors").factory("jtbCSRFHttpInterceptor",function(){var e;return{request:function(n){return angular.isDefined(e)&&(n.headers["X-XSRF-TOKEN"]=e),n},response:function(n){return angular.isDefined(n.headers)&&angular.isDefined(n.headers("XSRF-TOKEN"))&&null!==n.headers("XSRF-TOKEN")&&(e=n.headers("XSRF-TOKEN")),n}}}).config(["$httpProvider",function(e){e.interceptors.push("jtbCSRFHttpInterceptor")}]),angular.module("coreGamesUi.interceptors").factory("jtbGeneralErrorHandler",["$q","$rootScope",function(e,n){return{responseError:function(a){switch(a.status){case 409:break;case 401:console.log(JSON.stringify(a)),n.$broadcast("InvalidSession");break;default:console.log(JSON.stringify(a)),n.$broadcast("GeneralError")}return e.reject(a)}}}]).config(["$httpProvider",function(e){e.interceptors.push("jtbGeneralErrorHandler")}]),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$q","$injector","$window",function(e,n,a,t){function r(){var a=n.defer();return f?(a.resolve(),a.promise):(e.get("/api/social/apis",{cache:!0}).then(function(e){g=e.data.facebookAppId,p=e.data.facebookPermissions,angular.isDefined(d)?a.resolve():(window.fbAsyncInit=function(){window.FB.init({appId:g,xfbml:!1,version:"v2.2"}),a.resolve()},function(e,n,t){function r(){f=!1,a.reject()}var i,o=e.getElementsByTagName(n)[0];e.getElementById(t)||(i=e.createElement(n),i.id=t,i.src="//connect.facebook.net/en_US/sdk.js",i.onerror=r,o.parentNode.insertBefore(i,o))}(document,"script","facebook-jssdk")),f=!0},function(){a.reject()}),a.promise)}function i(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,e.resolve({auto:!0,permissions:p})):e.reject()};angular.isDefined(d)?d.login(p.split(",")).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.login(n,{scope:p})}catch(a){console.error(JSON.stringify(a)),e.reject()}}function o(e){var n=function(n){if(angular.isDefined(n)&&!angular.isDefined(n.error)){var a=p.split(","),t=!0;angular.forEach(a,function(e){var a=!1;angular.forEach(n.data,function(n){e!==n.permission||"granted"!==n.status&&"declined"!==n.status||(a=!0)}),a||(t=!1)}),t?e.resolve({auto:!0,permissions:p}):e.reject()}else e.reject()},a="/me/permissions";angular.isDefined(d)?d.api(a,[]).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.api(a,n)}function s(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,o(e)):e.reject()};angular.isDefined(d)?d.getLoginStatus().then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.getLoginStatus(n)}catch(a){console.error(JSON.stringify(a)),e.reject()}}function c(e,n,a){var t=!0,r="";angular.forEach(e,function(e){t?t=!1:r+=", ",r+=e});var i=function(e){a.resolve(e)},o={method:"apprequests",message:n,to:r};angular.isDefined(d)?d.showDialog(o).then(i,function(){a.reject()}):window.FB.ui(o,i)}function u(e,n){if("facebook"===e.source)try{var a=function(a){"connected"===a.status?(l=a.authResponse,n.resolve(a.authResponse.userID===e.sourceId)):n.resolve(!1)};angular.isDefined(d)?d.getLoginStatus().then(a,function(e){console.log(JSON.stringify(e)),n.resolve(!1)}):window.FB.getLoginStatus(a)}catch(t){console.error(JSON.stringify(t)),n.resolve(!1)}else n.resolve(!1)}var l,d,f=!1,g="",p="";try{0===t.location.href.indexOf("file:")&&(d=a.get("$cordovaFacebook"))}catch(m){d=void 0}return{currentAuthorization:function(){return l},initiateFBLogin:function(){var e=n.defer();return r().then(function(){i(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=n.defer();return r().then(function(){s(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,a){var t=n.defer();return r().then(function(){c(e,a,t)},function(){t.reject()}),t.promise},playerAndFBMatch:function(e){var a=n.defer();return r().then(function(){u(e,a)}),a.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$http","jtbLocalStorage","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q","$injector",function(e,n,a,t,r,i,o,s,c){function u(){return"gameCache-"+i.currentPlayer().md5}function l(){L.forEach(function(e){var n=D.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):D.put(e,{idMap:{},games:[]})})}function d(n){var a=0;for(var t in n.idMap)if(n.idMap.hasOwnProperty(t)){var r=n.games[n.idMap[t]],i=D.get(S),o=i.idMap[r.id];y(i,r,o),i=D.get(r.gamePhase),o=i.idMap[r.id],y(i,r,o),angular.isDefined(G)&&(i=D.get(G.getClassification(r)),o=i.idMap[r.id],y(i,r,o)),e.$broadcast("gameRemoved",r),++a}}function f(){t.setObject(u(),D.get(S).games)}function g(){var n=JSON.parse(JSON.stringify(D.get(S)));a.get(i.currentPlayerBaseURL()+"/games").then(function(a){angular.forEach(a.data,function(e){j.putUpdatedGame(e),angular.isDefined(n.idMap[e.id])&&delete n.idMap[e.id]}),d(n),f(),e.$broadcast("gameCachesLoaded",1)})}function p(){var n=t.getObject(u(),"[]");angular.forEach(n,function(e){j.putUpdatedGame(e)}),e.$broadcast("gameCachesLoaded",0)}function m(){var e=s.defer();return L.length>0?(l(),p(),e.resolve()):r.phases().then(function(n){L.slice(0),L.push(S),angular.forEach(n,function(e,n){L.push(n)}),angular.isDefined(G)&&angular.forEach(G.getClassifications(),function(e){L.push(e)}),l(),p(),e.resolve()},function(){e.reject()}),e.promise}function h(n,a){var t=D.get(n.gamePhase);t.games.push(n),t.idMap[n.id]=t.games.indexOf(n),angular.isDefined(G)&&(t=D.get(G.getClassification(n)),t.games.push(n),t.idMap[n.id]=t.games.indexOf(n)),a.games.push(n),a.idMap[n.id]=a.games.indexOf(n),e.$broadcast("gameAdded",n)}function y(e,n,a){delete e.idMap[n.id],e.games.splice(a,1);for(var t in e.idMap)if(e.idMap.hasOwnProperty(t)){var r=e.idMap[t];r>a&&(e.idMap[t]=r-1)}}function v(e,n,a,t){var r=D.get(e),i=r.idMap[n.id];if(e===a)r.games[i]=t;else{var o=D.get(a);o.idMap[t.id]=o.games.push(t)-1,y(r,n,i)}}function b(n,a,t,r){n.games[a]=t;var i=t.gamePhase,o=r.gamePhase;v(o,r,i,t),angular.isDefined(G)&&(i=G.getClassification(t),o=G.getClassification(r),v(o,r,i,t)),e.$broadcast("gameUpdated",r,t)}var S="All",D=n("game-gameCache"),L=[],j={},$="Have Live Game Feed "+o;console.info($);var G;try{G=c.get("jtbGameClassifier")}catch(F){G=void 0}return j={putUpdatedGame:function(e){var n=D.get(S),a=n.idMap[e.id];if(angular.isDefined(a)){var t=n.games[a];if(e.lastUpdate<=t.lastUpdate)return console.info("Skipping Stale game update for "+e.id),void 0;b(n,a,e,t)}else h(e,n);f()},getGameForID:function(e){var n=D.get(S);if(angular.isDefined(n)){var a=n.idMap[e];if(angular.isDefined(a))return n.games[a]}},getGamesForPhase:function(e){var n=D.get(e);return angular.isDefined(n)?n.games:void 0},initialized:function(){return angular.isDefined(D)&&angular.isDefined(D.get(S))}},e.$on("gameUpdate",function(n,a,t){j.putUpdatedGame(t),e.$apply()}),e.$on("playerLoaded",function(){m()}),e.$on("liveFeedEstablished",function(){m().then(function(){g()})}),e.$on("refreshGames",function(){m().then(function(){g()})}),j}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(e,n,a){function t(){angular.isDefined(i)&&(a.cancel(i),i=void 0),angular.isDefined(o)&&(console.log("ending livefeedsubcription to "+n.currentID()),o.close()),o=void 0}function r(e){t(),angular.isUndefined(e)&&(e=0),console.log("depth is "+e),i=a(function(){if(""!==n.currentID()){c.url=s+"/livefeed/"+n.currentID();try{o=u.subscribe(c)}catch(t){console.log("sub ex "+JSON.stringify(t)),5>e?i=a(function(){r(e+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}var i,o,s="",c={url:"",contentType:"application/json",logLevel:"info",transport:"websocket",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,closeAsync:!0,onOpen:function(n){var t=this;a(function(){console.info(t.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")})},onMessage:function(n){var t=this,r=angular.copy(n);a(function(){angular.isDefined(r.messages)?r.messages.forEach(function(n){var a;try{a=JSON.parse(n)}catch(t){return console.error("got non-parseable message"),void 0}if(angular.isDefined(a.messageType)){switch(a.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",a.game.id,a.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(a.message)),void 0;case"Player":return e.$broadcast("playerUpdate",a.player.id,a.player),void 0}console.warn("onMessage: unknown message type '"+a.messageType+"'")}console.warn("unknown message structure "+a)}):console.warn(t.url+" unknown onMessage: "+JSON.stringify(r))})},onClose:function(e){var n=this;a(function(){console.warn(n.url+" closed: "+JSON.stringify(e))})},onError:function(e){var n=this;a(function(){console.error(n.url+" onError: "+JSON.stringify(e))})}},u=atmosphere;return e.$on("playerLoaded",function(){r()}),""!==n.currentID()&&r(),{suspendFeed:function(){t()},setEndPoint:function(e){s=e,"http://localhost:9998"===s&&(c.transport="long-polling"),r()}}}]),angular.module("coreGamesUi.services").factory("jtbLocalStorage",["$window",function(e){return{set:function(n,a){e.localStorage[n]=a},get:function(n,a){return e.localStorage[n]||a},setObject:function(n,a){e.localStorage[n]=JSON.stringify(a)},getObject:function(n,a){return JSON.parse(e.localStorage[n]||a||"{}")}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$window","jtbFacebook","$q",function(e,n,a,t,r){function i(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function o(){e.get("/api/security",{cache:!0}).then(function(e){switch(s=e.data,c=s.id,u=s.id,s.source){case"facebook":t.playerAndFBMatch(s).then(function(e){e?i():f.signOutAndRedirect()},function(){f.signOutAndRedirect()});break;default:i()}})}var s,c="",u="",l="/api/player",d="/friends",f={};return f={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).then(function(e){s=e.data,u=s.id,i()})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return l},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+d).then(function(e){return e.data})},updateLastVersionNotes:function(n){e.post(l+"/lastVersionNotes/"+n)},initializeFriendsForController:function(e){var n=r.defer();return e.friends=[],e.invitableFBFriends=[],e.chosenFriends=[],f.currentPlayerFriends().then(function(a){angular.forEach(a.maskedFriends,function(n,a){var t={md5:a,displayName:n};e.friends.push(t)}),"facebook"===f.currentPlayer().source&&angular.forEach(a.invitableFriends,function(n){var a={id:n.id,name:n.name};angular.isDefined(n.picture)&&angular.isDefined(n.picture.url)&&(a.url=n.picture.url),e.invitableFBFriends.push(a)}),n.resolve()}),n.promise},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){a.location="#/signin"}).error(function(){a.location="#/signin"})}},n.$on("login",function(){console.log("login received"),o()}),n.$on("playerUpdate",function(e,a,t){u===a&&(angular.copy(t,s),n.$apply())}),f}]);