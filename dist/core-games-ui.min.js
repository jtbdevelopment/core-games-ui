!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi",["coreGamesUi.controllers","coreGamesUi.config","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.services","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreInviteCtrl",["$modalInstance","$scope","invitableFriends","jtbFacebook",function(e,n,o,r){n.invitableFriends=o,n.chosenFriends=[],n.invite=function(){var o=[];angular.forEach(n.chosenFriends,function(e){o.push(e.id)}),r.inviteFriends(o),e.close()},n.cancel=function(){e.dismiss()}}]),angular.module("coreGamesUi.controllers").controller("CoreSignInCtrl",["$scope","$window","$cookies","jtbFacebook",function(e,n,o,r){function a(){e.showFacebook=!0,e.showManual=n.location.href.indexOf("localhost")>-1||n.location.href.indexOf("-dev")>-1,e.message=""}function t(){e.showFacebook=!1,e.showManual=!1,e.message="Logging in via Facebook",n.location="/auth/facebook"}e.message="Initializing...",e.showFacebook=!1,e.showManual=!1,e.csrf=o["XSRF-TOKEN"],e.facebookPermissions="",r.canAutoSignIn().then(function(n){e.facebookPermissions=n.permissions,n.auto?t():a()},function(){a()}),e.fbLogin=function(){r.initiateFBLogin().then(function(e){e.auto?t():a()},function(){a()})}}]),angular.module("coreGamesUi.directives").directive("disableAnimation",function(e){return{restrict:"A",link:function(n,o,r){r.$observe("disableAnimation",function(n){e.enabled(!n,o)})}}}),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var o=[];return angular.isArray(e)?e.forEach(function(e){for(var r=!1,a=Object.keys(n),t=0;t<a.length;t++){var i=a[t],s=n[i].toLowerCase();if(-1!==e[i].toString().toLowerCase().indexOf(s)){r=!0;break}}r&&o.push(e)}):o=e,o}}),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$location","$q","$rootScope",function(e,n,o,r){function a(){var r=o.defer();return t?(r.resolve(),r.promise):(e.get("/api/social/apis",{cache:!0}).success(function(e){i=e.facebookAppId,s=e.facebookPermissions,window.fbAsyncInit=function(){FB.init({appId:i,xfbml:!1,version:"v2.2"}),r.resolve(s)},function(e,n,o){function a(){t=!1,r.reject()}var i,s=e.getElementsByTagName(n)[0];e.getElementById(o)||(i=e.createElement(n),i.id=o,i.src="//connect.facebook.net/en_US/sdk.js",i.onerror=a,s.parentNode.insertBefore(i,s))}(document,"script","facebook-jssdk"),t=!0}).error(function(){n.path("/error"),r.reject()}),r.promise)}var t=!1,i="",s="";return r.$on("event",function(e,n,o){var r=o;angular.isDefined(r)||(r={});var a=n;angular.isDefined(n)||(a=1);try{FB.AppEvents.logEvent(e,a,r)}catch(t){console.debug("Failed to log to FB "+t)}}),{initiateFBLogin:function(){var e=o.defer();return a().then(function(){try{FB.login(function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?e.resolve({auto:!0,permissions:s}):e.reject()},{scope:s})}catch(n){console.error(JSON.stringify(n)),e.reject()}},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=o.defer();return a().then(function(n){try{FB.getLoginStatus(function(o){angular.isDefined(o)&&angular.isDefined(o.status)&&"connected"===o.status?FB.api("/me/permissions",function(o){if(angular.isDefined(o)&&!angular.isDefined(o.error)){var r=n.split(","),a=!0;angular.forEach(r,function(e){var n=!1;angular.forEach(o.data,function(o){e!==o.permission||"granted"!==o.status&&"declined"!==o.status||(n=!0)}),n||(a=!1)}),a?e.resolve({auto:!0,permissions:n}):e.reject()}else e.reject()}):e.reject()})}catch(o){console.error(JSON.stringify(o))}},function(){e.reject()}),e.promise},inviteFriends:function(e){a().then(function(){var n=!0,o="";angular.forEach(e,function(e){n?n=!1:o+=", ",o+=e}),FB.ui({method:"apprequests",message:"Come play Twisted Hangman with me!",to:o},function(e){console.info(JSON.stringify(e))})},function(){})},playerAndFBMatch:function(e){var n=o.defer();return a().then(function(){if("facebook"===e.source)try{FB.getLoginStatus(function(o){"connected"===o.status?n.resolve(o.authResponse.userID===e.sourceId):n.resolve(!1)})}catch(o){console.error(JSON.stringify),n.resolve(!1)}else n.resolve(!1)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$location","$http","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed",function(e,n,o,r,a,t,i){function s(){d.forEach(function(e){var n=f.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):f.put(e,{idMap:{},games:[]})})}function c(){s(),r.get(t.currentPlayerBaseURL()+"/games").success(function(n){m=!0,n.forEach(function(e){h.putUpdatedGame(e)}),m=!1,++g,e.$broadcast("gameCachesLoaded",g)}).error(function(){o.path("/error")})}function u(){a.phases().then(function(e){d.slice(0),d.push(l),angular.forEach(e,function(e,n){d.push(n)}),s()},function(){o.path("/error")})}var l="All",f=n("game-gameCache"),d=[],g=0,m=!1,p="Have Live Game Feed "+i;console.info(p);var h={putUpdatedGame:function(n){var o=f.get(l),r=o.idMap[n.id];if(angular.isDefined(r)){var a=o.games[r];if(n.lastUpdate<=a.lastUpdate)return console.info("Skipping Stale game update for "+n.id),void 0;o.games[r]=n;var t=f.get(a.gamePhase),i=t.idMap[a.id];if(a.gamePhase===n.gamePhase)t.games[i]=n;else{var s=f.get(n.gamePhase);s.games.push(n),s.idMap[n.id]=s.games.indexOf(n),t.games.splice(i,1),delete t.idMap[a.id]}m===!1&&e.$broadcast("gameUpdated",a,n)}else{var c=f.get(n.gamePhase);c.games.push(n),c.idMap[n.id]=c.games.indexOf(n),o.games.push(n),o.idMap[n.id]=o.games.indexOf(n),m===!1&&e.$broadcast("gameAdded",n)}},getGameForID:function(e){var n=f.get(l);if(angular.isDefined(n)){var o=n.idMap[e];if(angular.isDefined(o))return n.games[o]}},getGamesForPhase:function(e){return f.get(e).games}};return e.$on("gameUpdate",function(n,o,r){h.putUpdatedGame(r),e.$apply()}),e.$on("liveFeedEstablished",function(){c()}),e.$on("refreshGames",function(){c()}),u(),h}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService",function(e,n){function o(){console.log("livefeedsubcription to "+n.currentID()),angular.isDefined(r)&&r.close(),t.url=a+"/livefeed/"+n.currentID(),r=i.subscribe(t)}var r,a="",t={url:"",contentType:"application/json",logLevel:"debug",transport:"long-polling",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,onOpen:function(n){console.info(this.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")},onMessage:function(n){angular.isDefined(n.messages)?n.messages.forEach(function(n){var o;try{o=JSON.parse(n)}catch(r){return console.error("got non-parseable message"),void 0}if(angular.isDefined(o.messageType)){switch(o.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",o.game.id,o.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(o.message)),void 0;case"Player":return e.$broadcast("playerUpdate",o.player.id,o.player),void 0;default:console.warn("onMessage: unknown message type '"+o.messageType+"'")}console.warn("onMessage: unknown message type '"+o.messageType+"'")}console.warn("unknown message structure "+o)}):console.warn(this.url+" unknown onMessage: "+JSON.stringify(n))},onClose:function(e){console.warn(this.url+" closed: "+JSON.stringify(e))},onError:function(e){console.error(this.url+" onError: "+JSON.stringify(e))}},i=$.atmosphere;return e.$on("playerLoaded",function(){o()}),""!==n.currentID()&&o(),{setServiceBase:function(e){a=e},handler:function(){return t}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$location","$window","jtbFacebook",function(e,n,o,r,a){function t(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function i(){e.get("/api/security",{cache:!0}).success(function(e){switch(s=e,c=s.id,u=s.id,s.source){case"facebook":a.playerAndFBMatch(s).then(function(e){e?t():d.signOutAndRedirect()},function(){d.signOutAndRedirect()});break;default:t()}}).error(function(){o.path("/error")})}var s,c="",u="",l="/api/player",f="/friends",d={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).success(function(e){u=e.id,s=e,t()}).error(function(){o.path("/error")})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return l},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+f).then(function(e){return e.data})},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){r.location="/signin"}).error(function(){r.location="/signin"})}};return n.$on("login",function(){console.log("login received"),i()}),n.$on("playerUpdate",function(e,o,r){u===o&&(angular.copy(r,s),n.$apply())}),i(),d}]);