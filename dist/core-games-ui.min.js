!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi",["coreGamesUi.controllers","coreGamesUi.config","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.services","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreInviteCtrl",["$modalInstance","$scope","invitableFriends","message","jtbFacebook",function(e,n,o,r,t){n.invitableFriends=o,n.chosenFriends=[],n.message=r,n.invite=function(){var o=[];angular.forEach(n.chosenFriends,function(e){o.push(e.id)}),t.inviteFriends(o,r),e.close()},n.cancel=function(){e.dismiss()}}]),angular.module("coreGamesUi.controllers").controller("CoreSignInCtrl",["$scope","$window","$cookies","jtbFacebook",function(e,n,o,r){function t(){e.showFacebook=!0,e.showManual=n.location.href.indexOf("localhost")>-1||n.location.href.indexOf("-dev")>-1,e.message=""}function i(){e.showFacebook=!1,e.showManual=!1,e.message="Logging in via Facebook",n.location="/auth/facebook"}e.message="Initializing...",e.showFacebook=!1,e.showManual=!1,e.csrf=o["XSRF-TOKEN"],e.fbLogin=function(){r.initiateFBLogin().then(function(e){e.auto?i():t()},function(){t()})},r.canAutoSignIn().then(function(e){e.auto?i():t()},function(){t()})}]),angular.module("coreGamesUi.directives").directive("disableAnimation",function(e){return{restrict:"A",link:function(n,o,r){r.$observe("disableAnimation",function(n){e.enabled(!n,o)})}}}),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var o=[];return angular.isArray(e)?e.forEach(function(e){for(var r=!1,t=Object.keys(n),i=0;i<t.length;i++){var a=t[i],s=n[a].toLowerCase();if(-1!==e[a].toString().toLowerCase().indexOf(s)){r=!0;break}}r&&o.push(e)}):o=e,o}}),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$location","$q","$injector","$window",function(e,n,o,r,t){function i(){var r=o.defer();return g?(r.resolve(),r.promise):(e.get("/api/social/apis",{cache:!0}).success(function(e){p=e.facebookAppId,m=e.facebookPermissions,angular.isDefined(d)?r.resolve():(window.fbAsyncInit=function(){FB.init({appId:p,xfbml:!1,version:"v2.2"}),r.resolve()},function(e,n,o){function t(){g=!1,r.reject()}var i,a=e.getElementsByTagName(n)[0];e.getElementById(o)||(i=e.createElement(n),i.id=o,i.src="//connect.facebook.net/en_US/sdk.js",i.onerror=t,a.parentNode.insertBefore(i,a))}(document,"script","facebook-jssdk")),g=!0}).error(function(){n.path("/error"),r.reject()}),r.promise)}function a(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,e.resolve({auto:!0,permissions:m})):e.reject()};angular.isDefined(d)?d.login(m.split(",")).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.login(n,{scope:m})}catch(o){console.error(JSON.stringify(o)),e.reject()}}function s(e){var n=function(n){if(angular.isDefined(n)&&!angular.isDefined(n.error)){var o=m.split(","),r=!0;angular.forEach(o,function(e){var o=!1;angular.forEach(n.data,function(n){e!==n.permission||"granted"!==n.status&&"declined"!==n.status||(o=!0)}),o||(r=!1)}),r?e.resolve({auto:!0,permissions:m}):e.reject()}else e.reject()},o="/me/permissions";angular.isDefined(d)?d.api(o,[]).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.api(o,n)}function c(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,s(e)):e.reject()};angular.isDefined(d)?d.getLoginStatus().then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.getLoginStatus(n)}catch(o){console.error(JSON.stringify(o)),e.reject()}}function u(e,n){var o=!0,r="";angular.forEach(e,function(e){o?o=!1:r+=", ",r+=e});var t=function(e){console.info(JSON.stringify(e))},i={method:"apprequests",message:n,to:r};angular.isDefined(d)?d.showDialog(i).then(t,function(){}):FB.ui(i,t)}function f(e,n){if("facebook"===e.source)try{var o=function(o){"connected"===o.status?(l=o.authResponse,n.resolve(o.authResponse.userID===e.sourceId)):n.resolve(!1)};angular.isDefined(d)?d.getLoginStatus().then(o,function(e){console.log(JSON.stringify(e)),n.resolve(!1)}):FB.getLoginStatus(o)}catch(r){console.error(JSON.stringify),n.resolve(!1)}else n.resolve(!1)}var l,d,g=!1,p="",m="";try{0===t.location.href.indexOf("file:")&&(d=r.get("$cordovaFacebook"))}catch(h){d=void 0}return{currentAuthorization:function(){return l},initiateFBLogin:function(){var e=o.defer();return i().then(function(){a(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=o.defer();return i().then(function(){c(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,n){i().then(function(){u(e,n)},function(){})},playerAndFBMatch:function(e){var n=o.defer();return i().then(function(){f(e,n)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$location","$http","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q",function(e,n,o,r,t,i,a,s){function c(){m.forEach(function(e){var n=p.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):p.put(e,{idMap:{},games:[]})})}function u(){f().then(function(){c(),r.get(i.currentPlayerBaseURL()+"/games").success(function(n){v=!0,n.forEach(function(e){b.putUpdatedGame(e)}),v=!1,++h,e.$broadcast("gameCachesLoaded",h)}).error(function(){o.path("/error")})},function(){o.path("/error")})}function f(){var e=s.defer();return m.length>0?e.resolve():t.phases().then(function(n){m.slice(0),m.push(g),angular.forEach(n,function(e,n){m.push(n)}),c(),e.resolve()},function(){o.path("/error"),e.reject()}),e.promise}function l(n,o){var r=p.get(n.gamePhase);r.games.push(n),r.idMap[n.id]=r.games.indexOf(n),o.games.push(n),o.idMap[n.id]=o.games.indexOf(n),v===!1&&e.$broadcast("gameAdded",n)}function d(n,o,r,t){n.games[o]=r;var i=p.get(t.gamePhase),a=i.idMap[t.id];if(t.gamePhase===r.gamePhase)i.games[a]=r;else{var s=p.get(r.gamePhase);s.idMap[r.id]=s.games.push(r)-1,delete i.idMap[t.id],i.games.splice(a,1);for(var c in i.idMap)if(i.idMap.hasOwnProperty(c)){var u=i.idMap[c];u>a&&(i.idMap[c]=u-1)}}v===!1&&e.$broadcast("gameUpdated",t,r)}var g="All",p=n("game-gameCache"),m=[],h=0,v=!1,y="Have Live Game Feed "+a;console.info(y);var b={putUpdatedGame:function(e){var n=p.get(g),o=n.idMap[e.id];if(angular.isDefined(o)){var r=n.games[o];if(e.lastUpdate<=r.lastUpdate)return console.info("Skipping Stale game update for "+e.id),void 0;d(n,o,e,r)}else l(e,n)},getGameForID:function(e){var n=p.get(g);if(angular.isDefined(n)){var o=n.idMap[e];if(angular.isDefined(o))return n.games[o]}},getGamesForPhase:function(e){return p.get(e).games},initialized:function(){return angular.isDefined(p)&&angular.isDefined(p.get(g))}};return e.$on("gameUpdate",function(n,o,r){b.putUpdatedGame(r),e.$apply()}),e.$on("playerLoaded",function(){f()}),e.$on("liveFeedEstablished",function(){u()}),e.$on("refreshGames",function(){u()}),b}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(e,n,o){function r(){angular.isDefined(i)&&(o.cancel(i),i=void 0),angular.isDefined(a)&&(console.log("ending livefeedsubcription to "+n.currentID()),a.close()),a=void 0}function t(e){r(),angular.isUndefined(e)&&(e=0),i=o(function(){if(""!==n.currentID()){c.url=s+"/livefeed/"+n.currentID();try{a=u.subscribe(c)}catch(r){console.log(JSON.stringify(r)),5>e?i=o(function(){t(e+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}var i,a,s="",c={url:"",contentType:"application/json",logLevel:"info",transport:"long-polling",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,onOpen:function(n){console.info(this.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")},onMessage:function(n){angular.isDefined(n.messages)?n.messages.forEach(function(n){var o;try{o=JSON.parse(n)}catch(r){return console.error("got non-parseable message"),void 0}if(angular.isDefined(o.messageType)){switch(o.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",o.game.id,o.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(o.message)),void 0;case"Player":return e.$broadcast("playerUpdate",o.player.id,o.player),void 0;default:console.warn("onMessage: unknown message type '"+o.messageType+"'")}console.warn("onMessage: unknown message type '"+o.messageType+"'")}console.warn("unknown message structure "+o)}):console.warn(this.url+" unknown onMessage: "+JSON.stringify(n))},onClose:function(e){console.warn(this.url+" closed: "+JSON.stringify(e))},onError:function(e){console.error(this.url+" onError: "+JSON.stringify(e))}},u=atmosphere;return e.$on("playerLoaded",function(){t()}),""!==n.currentID()&&t(),{suspendFeed:function(){r()},setEndPoint:function(e){s=e},handler:function(){return c}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$location","$window","jtbFacebook",function(e,n,o,r,t){function i(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function a(){e.get("/api/security",{cache:!0}).success(function(e){switch(s=e,c=s.id,u=s.id,s.source){case"facebook":t.playerAndFBMatch(s).then(function(e){e?i():d.signOutAndRedirect()},function(){d.signOutAndRedirect()});break;default:i()}}).error(function(){o.path("/error")})}var s,c="",u="",f="/api/player",l="/friends",d={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).success(function(e){u=e.id,s=e,i()}).error(function(){o.path("/error")})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return f},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+l).then(function(e){return e.data})},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){r.location="#/signin"}).error(function(){r.location="#/signin"})}};return n.$on("login",function(){console.log("login received"),a()}),n.$on("playerUpdate",function(e,o,r){u===o&&(angular.copy(r,s),n.$apply())}),d}]);