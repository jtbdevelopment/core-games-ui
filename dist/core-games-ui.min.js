!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi.interceptors",[]),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi",["coreGamesUi.config","coreGamesUi.interceptors","coreGamesUi.services","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.controllers","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreAdminCtrl",["$scope","$http","jtbPlayerService",function(e,n,a){var t=this;t.searchText="",t.pageSize=20,t.players=[],t.computeRevertFields=function(){t.revertEnabled=a.realPID()!==a.currentID(),t.revertText=t.revertEnabled?"You are simulating another player.":"You are yourself."},t.playerCount=0,t.gameCount=0,t.playersCreated24hours=0,t.playersCreated7days=0,t.playersCreated30days=0,t.playersLastLogin24hours=0,t.playersLastLogin7days=0,t.playersLastLogin30days=0,t.gamesLast24hours=0,t.gamesLast7days=0,t.gamesLast30days=0;var r=Math.floor((new Date).getTime()/1e3),i=86400,o=r-i,s=r-7*i,c=r-30*i;function u(){var e="?pageSize="+t.pageSize+"&page="+(t.currentPage-1)+"&like="+t.searchText;n.get("/api/player/admin/playersLike/"+e).then(function(e){var n;n=e.data,t.totalItems=n.totalElements,t.numberOfPages=n.totalPages,t.players=n.content,t.currentPage=n.number+1})}n.get("/api/player/admin/playerCount").then(function(e){t.playerCount=e.data}),n.get("/api/player/admin/gameCount").then(function(e){t.gameCount=e.data}),n.get("/api/player/admin/playersCreated/"+o).then(function(e){t.playersCreated24hours=e.data}),n.get("/api/player/admin/playersCreated/"+s).then(function(e){t.playersCreated7days=e.data}),n.get("/api/player/admin/playersCreated/"+c).then(function(e){t.playersCreated30days=e.data}),n.get("/api/player/admin/playersLoggedIn/"+o).then(function(e){t.playersLastLogin24hours=e.data}),n.get("/api/player/admin/playersLoggedIn/"+s).then(function(e){t.playersLastLogin7days=e.data}),n.get("/api/player/admin/playersLoggedIn/"+c).then(function(e){t.playersLastLogin30days=e.data}),n.get("/api/player/admin/gamesSince/"+o).then(function(e){t.gamesLast24hours=e.data}),n.get("/api/player/admin/gamesSince/"+s).then(function(e){t.gamesLast7days=e.data}),n.get("/api/player/admin/gamesSince/"+c).then(function(e){t.gamesLast30days=e.data}),t.refreshData=function(){t.players.slice(0),t.totalItems=0,t.numberOfPages=0,t.currentPage=1,u()},t.changePage=function(){u()},t.switchToPlayer=function(e){a.overridePID(e)},t.revertToNormal=function(){a.overridePID(a.realPID())},t.refreshData(),t.computeRevertFields(),e.$on("playerLoaded",function(){t.computeRevertFields()})}]),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,o){var s=[];return angular.isArray(e)?e.forEach(function(e){for(var n=!1,a=Object.keys(o),t=0;t<a.length;t++){var r=a[t],i=o[r].toLowerCase();if(-1!==e[r].toString().toLowerCase().indexOf(i)){n=!0;break}}n&&s.push(e)}):s=e,s}}),angular.module("coreGamesUi.interceptors").factory("jtbCSRFHttpInterceptor",function(){var n;return{request:function(e){return angular.isDefined(n)&&(e.headers["X-XSRF-TOKEN"]=n),e},response:function(e){return angular.isDefined(e.headers)&&angular.isDefined(e.headers("XSRF-TOKEN"))&&null!==e.headers("XSRF-TOKEN")&&(n=e.headers("XSRF-TOKEN")),e}}}).config(["$httpProvider",function(e){e.interceptors.push("jtbCSRFHttpInterceptor")}]),angular.module("coreGamesUi.interceptors").factory("jtbGeneralErrorHandler",["$q","$rootScope",function(n,a){return{responseError:function(e){switch(e.status){case 409:break;case 401:console.log(JSON.stringify(e)),a.$broadcast("InvalidSession");break;default:console.log(JSON.stringify(e)),a.$broadcast("GeneralError")}return n.reject(e)}}}]).config(["$httpProvider",function(e){e.interceptors.push("jtbGeneralErrorHandler")}]),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$q","$injector","$window",function(e,t,n,a){var i,s,o=!1,c="",u="";try{0===a.location.href.indexOf("file:")&&(s=n.get("$cordovaFacebook"))}catch(e){s=void 0}function r(){var i=t.defer();return o?i.resolve():e.get("/api/social/apis",{cache:!0}).then(function(e){var n,a,t,r;c=e.data.facebookAppId,u=e.data.facebookPermissions,angular.isDefined(s)?i.resolve():(window.fbAsyncInit=function(){window.FB.init({appId:c,xfbml:!1,version:"v2.2"}),i.resolve()},n=document,a="facebook-jssdk",r=n.getElementsByTagName("script")[0],n.getElementById(a)||((t=n.createElement("script")).id=a,t.src="//connect.facebook.net/en_US/sdk.js",t.onerror=function(){o=!1,i.reject()},r.parentNode.insertBefore(t,r))),o=!0},function(){i.reject()}),i.promise}function l(r){try{var e=function(e){var a,n,t;angular.isDefined(e)&&angular.isDefined(e.status)&&"connected"===e.status?(i=e.authResponse,a=r,n=function(e){if(angular.isDefined(e)&&!angular.isDefined(e.error)){var n=u.split(","),t=!0;angular.forEach(n,function(n){var a=!1;angular.forEach(e.data,function(e){n!==e.permission||"granted"!==e.status&&"declined"!==e.status||(a=!0)}),a||(t=!1)}),t?a.resolve({auto:!0,permissions:u}):a.reject()}else a.reject()},t="/me/permissions",angular.isDefined(s)?s.api(t,[]).then(n,function(e){console.log(JSON.stringify(e)),a.reject()}):window.FB.api(t,n)):r.reject()};angular.isDefined(s)?s.getLoginStatus().then(e,function(e){console.log(JSON.stringify(e)),r.reject()}):window.FB.getLoginStatus(e)}catch(e){console.error(JSON.stringify(e)),r.reject()}}return{currentAuthorization:function(){return i},initiateFBLogin:function(){var e=t.defer();return r().then(function(){!function(n){try{var e=function(e){angular.isDefined(e)&&angular.isDefined(e.status)&&"connected"===e.status?(i=e.authResponse,n.resolve({auto:!0,permissions:u})):n.reject()};angular.isDefined(s)?s.login(u.split(",")).then(e,function(e){console.log(JSON.stringify(e)),n.reject()}):window.FB.login(e,{scope:u})}catch(e){console.error(JSON.stringify(e)),n.reject()}}(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=t.defer();return r().then(function(){l(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,n){var a=t.defer();return r().then(function(){!function(e,n,a){var t=!0,r="";angular.forEach(e,function(e){t?t=!1:r+=", ",r+=e});var i=function(e){a.resolve(e)},o={method:"apprequests",message:n,to:r};angular.isDefined(s)?s.showDialog(o).then(i,function(){a.reject()}):window.FB.ui(o,i)}(e,n,a)},function(){a.reject()}),a.promise},playerAndFBMatch:function(e){var n=t.defer();return r().then(function(){!function(n,a){if("facebook"===n.source)try{var e=function(e){"connected"===e.status?(i=e.authResponse,a.resolve(e.authResponse.userID===n.sourceId)):a.resolve(!1)};angular.isDefined(s)?s.getLoginStatus().then(e,function(e){console.log(JSON.stringify(e)),a.resolve(!1)}):window.FB.getLoginStatus(e)}catch(e){console.error(JSON.stringify(e)),a.resolve(!1)}else a.resolve(!1)}(e,n)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$http","jtbLocalStorage","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q","$injector",function(d,e,a,n,t,r,i,o,s){var f,g="All",p=e("game-gameCache"),c=[],u={},l="Have Live Game Feed "+i;console.info(l);try{f=s.get("jtbGameClassifier")}catch(e){f=void 0}function m(){return"gameCache-"+r.currentPlayer().md5}function h(){c.forEach(function(e){var n=p.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):p.put(e,{idMap:{},games:[]})})}function y(){n.setObject(m(),p.get(g).games)}function v(){var n=JSON.parse(JSON.stringify(p.get(g)));a.get(r.currentPlayerBaseURL()+"/games").then(function(e){angular.forEach(e.data,function(e){u.putUpdatedGame(e),angular.isDefined(n.idMap[e.id])&&delete n.idMap[e.id]}),function(e){for(var n in e.idMap)if(e.idMap.hasOwnProperty(n)){var a=e.games[e.idMap[n]],t=p.get(g),r=t.idMap[a.id];D(t,a,r),D(t=p.get(a.gamePhase),a,r=t.idMap[a.id]),angular.isDefined(f)&&D(t=p.get(f.getClassification(a)),a,r=t.idMap[a.id]),d.$broadcast("gameRemoved",a)}}(n),y(),d.$broadcast("gameCachesLoaded",1)})}function b(){var e=n.getObject(m(),"[]");angular.forEach(e,function(e){u.putUpdatedGame(e)}),d.$broadcast("gameCachesLoaded",0)}function S(){var n=o.defer();return 0<c.length?(h(),b(),n.resolve()):t.phases().then(function(e){c.slice(0),c.push(g),angular.forEach(e,function(e,n){c.push(n)}),angular.isDefined(f)&&angular.forEach(f.getClassifications(),function(e){c.push(e)}),h(),b(),n.resolve()},function(){n.reject()}),n.promise}function D(e,n,a){for(var t in delete e.idMap[n.id],e.games.splice(a,1),e.idMap)if(e.idMap.hasOwnProperty(t)){var r=e.idMap[t];a<r&&(e.idMap[t]=r-1)}}function L(e,n,a,t){var r=p.get(e),i=r.idMap[n.id];if(e===a)r.games[i]=t;else{var o=p.get(a);o.idMap[t.id]=o.games.push(t)-1,D(r,n,i)}}return u={putUpdatedGame:function(e){var n,a,t,r,i,o,s,c=p.get(g),u=c.idMap[e.id];if(angular.isDefined(u)){var l=c.games[u];if(e.lastUpdate<=l.lastUpdate)return void console.info("Skipping Stale game update for "+e.id);r=u,i=e,o=l,s=(c.games[r]=i).gamePhase,L(o.gamePhase,o,s,i),angular.isDefined(f)&&(s=f.getClassification(i),L(f.getClassification(o),o,s,i)),d.$broadcast("gameUpdated",o,i)}else n=e,a=c,(t=p.get(n.gamePhase)).games.push(n),t.idMap[n.id]=t.games.indexOf(n),angular.isDefined(f)&&((t=p.get(f.getClassification(n))).games.push(n),t.idMap[n.id]=t.games.indexOf(n)),a.games.push(n),a.idMap[n.id]=a.games.indexOf(n),d.$broadcast("gameAdded",n);y()},getGameForID:function(e){var n=p.get(g);if(angular.isDefined(n)){var a=n.idMap[e];if(angular.isDefined(a))return n.games[a]}},getGamesForPhase:function(e){var n=p.get(e);if(angular.isDefined(n))return n.games},initialized:function(){return angular.isDefined(p)&&angular.isDefined(p.get(g))}},d.$on("gameUpdate",function(e,n,a){u.putUpdatedGame(a),d.$apply()}),d.$on("playerLoaded",function(){S()}),d.$on("liveFeedEstablished",function(){S().then(function(){v()})}),d.$on("refreshGames",function(){S().then(function(){v()})}),u}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(t,e,r){var a,i,o="",s={url:"",contentType:"application/json",logLevel:"info",transport:"websocket",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,closeAsync:!0,onOpen:function(e){var n=this;r(function(){console.info(n.url+" Atmosphere connected using "+e.transport),t.$broadcast("liveFeedEstablished")})},onMessage:function(e){var n=this,a=angular.copy(e);r(function(){angular.isDefined(a.messages)?a.messages.forEach(function(e){var n;try{n=JSON.parse(e)}catch(e){return void console.error("got non-parseable message")}if(angular.isDefined(n.messageType)){switch(n.messageType.toString()){case"Game":return void t.$broadcast("gameUpdate",n.game.id,n.game);case"Heartbeat":return void console.info("got a heartbeat "+JSON.stringify(n.message));case"Player":return void t.$broadcast("playerUpdate",n.player.id,n.player)}console.warn("onMessage: unknown message type '"+n.messageType+"'")}console.warn("unknown message structure "+n)}):console.warn(n.url+" unknown onMessage: "+JSON.stringify(a))})},onClose:function(e){var n=this;r(function(){console.warn(n.url+" closed: "+JSON.stringify(e))})},onError:function(e){var n=this;r(function(){console.error(n.url+" onError: "+JSON.stringify(e))})}},c=atmosphere;function u(){angular.isDefined(a)&&(r.cancel(a),a=void 0),angular.isDefined(i)&&(console.log("ending livefeedsubcription to "+e.currentID()),i.close()),i=void 0}function l(n){u(),angular.isUndefined(n)&&(n=0),console.log("depth is "+n),a=r(function(){if(""!==e.currentID()){s.url=o+"/livefeed/"+e.currentID();try{i=c.subscribe(s)}catch(e){console.log("sub ex "+JSON.stringify(e)),n<5?a=r(function(){l(n+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}return t.$on("playerLoaded",function(){l()}),""!==e.currentID()&&l(),{suspendFeed:function(){u()},setEndPoint:function(e){"http://localhost:9998"===(o=e)&&(s.transport="long-polling"),l()}}}]),angular.module("coreGamesUi.services").factory("jtbLocalStorage",["$window",function(a){return{set:function(e,n){a.localStorage[e]=n},get:function(e,n){return a.localStorage[e]||n},setObject:function(e,n){a.localStorage[e]=JSON.stringify(n)},getObject:function(e,n){return JSON.parse(a.localStorage[e]||n||"{}")}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$window","jtbFacebook","$q",function(n,t,e,a,r){var i,o="",s="",c="/api/player",u={};function l(){console.log("Broadcasting playerLoad"),t.$broadcast("playerLoaded")}return u={overridePID:function(e){n.put(this.currentPlayerBaseURL()+"/admin/"+e).then(function(e){i=e.data,s=i.id,l()})},realPID:function(){return o},currentID:function(){return s},currentPlayerBaseURL:function(){return c},currentPlayerFriends:function(){return n.get(this.currentPlayerBaseURL()+"/friendsV2").then(function(e){return e.data})},updateLastVersionNotes:function(e){n.post(c+"/lastVersionNotes/"+e)},initializeFriendsForController:function(t){var n=r.defer();return t.friends=[],t.invitableFBFriends=[],t.chosenFriends=[],u.currentPlayerFriends().then(function(e){angular.forEach(e.maskedFriends,function(e,n){var a={md5:n,displayName:e};t.friends.push(a)}),"facebook"===u.currentPlayer().source&&angular.forEach(e.invitableFriends,function(e){var n={id:e.id,name:e.name};angular.isDefined(e.picture)&&angular.isDefined(e.picture.url)&&(n.url=e.picture.url),t.invitableFBFriends.push(n)}),n.resolve()}),n.promise},currentPlayer:function(){return i},signOutAndRedirect:function(){n.post("/signout").success(function(){e.location="#/signin"}).error(function(){e.location="#/signin"})}},t.$on("login",function(){console.log("login received"),n.get("/api/security",{cache:!0}).then(function(e){switch(i=e.data,o=i.id,s=i.id,i.source){case"facebook":a.playerAndFBMatch(i).then(function(e){e?l():u.signOutAndRedirect()},function(){u.signOutAndRedirect()});break;default:l()}})}),t.$on("playerUpdate",function(e,n,a){s===n&&(angular.copy(a,i),t.$apply())}),u}]);