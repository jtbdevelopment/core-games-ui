!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi.interceptors",[]),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi",["coreGamesUi.config","coreGamesUi.interceptors","coreGamesUi.services","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.controllers","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreAdminCtrl",["$scope","$http","jtbPlayerService",function(e,n,r){function a(){n.get("/api/player/admin/playersCreated/"+f).success(function(e){c.playersCreated24hours=e}),n.get("/api/player/admin/playersCreated/"+d).success(function(e){c.playersCreated7days=e}),n.get("/api/player/admin/playersCreated/"+g).success(function(e){c.playersCreated30days=e})}function t(){n.get("/api/player/admin/playersLoggedIn/"+f).success(function(e){c.playersLastLogin24hours=e}),n.get("/api/player/admin/playersLoggedIn/"+d).success(function(e){c.playersLastLogin7days=e}),n.get("/api/player/admin/playersLoggedIn/"+g).success(function(e){c.playersLastLogin30days=e})}function o(){n.get("/api/player/admin/gamesSince/"+f).success(function(e){c.gamesLast24hours=e}),n.get("/api/player/admin/gamesSince/"+d).success(function(e){c.gamesLast7days=e}),n.get("/api/player/admin/gamesSince/"+g).success(function(e){c.gamesLast30days=e})}function i(e){c.totalItems=e.totalElements,c.numberOfPages=e.totalPages,c.players=e.content,c.currentPage=e.number+1}function s(){var e="?pageSize="+c.pageSize+"&page="+(c.currentPage-1)+"&like="+c.searchText;n.get("/api/player/admin/playersLike/"+e).then(function(e){i(e.data)},function(e,n){console.error(e+"/"+n)})}var c=this;c.searchText="",c.pageSize=20,c.players=[],c.computeRevertFields=function(){c.revertEnabled=r.realPID()!==r.currentID(),c.revertText=c.revertEnabled?"You are simulating another player.":"You are yourself."},c.playerCount=0,c.gameCount=0,c.playersCreated24hours=0,c.playersCreated7days=0,c.playersCreated30days=0,c.playersLastLogin24hours=0,c.playersLastLogin7days=0,c.playersLastLogin30days=0,c.gamesLast24hours=0,c.gamesLast7days=0,c.gamesLast30days=0;var u=Math.floor((new Date).getTime()/1e3),l=86400,f=u-l,d=u-7*l,g=u-30*l;n.get("/api/player/admin/playerCount").success(function(e){c.playerCount=e}),n.get("/api/player/admin/gameCount").success(function(e){c.gameCount=e}),a(),t(),o(),c.refreshData=function(){c.players.slice(0),c.totalItems=0,c.numberOfPages=0,c.currentPage=1,s()},c.changePage=function(){s()},c.switchToPlayer=function(e){r.overridePID(e)},c.revertToNormal=function(){r.overridePID(r.realPID())},c.refreshData(),c.computeRevertFields(),e.$on("playerLoaded",function(){c.computeRevertFields()})}]),angular.module("coreGamesUi.directives").directive("disableAnimation",function(e){return{restrict:"A",link:function(n,r,a){a.$observe("disableAnimation",function(n){e.enabled(!n,r)})}}}),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var r=[];return angular.isArray(e)?e.forEach(function(e){for(var a=!1,t=Object.keys(n),o=0;o<t.length;o++){var i=t[o],s=n[i].toLowerCase();if(-1!==e[i].toString().toLowerCase().indexOf(s)){a=!0;break}}a&&r.push(e)}):r=e,r}}),angular.module("coreGamesUi.interceptors").factory("jtbCSRFHttpInterceptor",function(){var e;return{request:function(n){return angular.isDefined(e)&&(n.headers["X-XSRF-TOKEN"]=e),n},response:function(n){return angular.isDefined(n.headers)&&angular.isDefined(n.headers("XSRF-TOKEN"))&&null!==n.headers("XSRF-TOKEN")&&(e=n.headers("XSRF-TOKEN")),n}}}).config(["$httpProvider",function(e){e.interceptors.push("jtbCSRFHttpInterceptor")}]),angular.module("coreGamesUi.interceptors").factory("jtbUnauthorizedHandler",["$q","$rootScope",function(e,n){return{responseError:function(r){return console.log("responseError:"+JSON.stringify(r)),401===r.status&&n.$broadcast("InvalidSession"),e.reject(r)}}}]).config(["$httpProvider",function(e){e.interceptors.push("jtbUnauthorizedHandler")}]),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$location","$q","$injector","$window",function(e,n,r,a,t){function o(){var a=r.defer();return g?(a.resolve(),a.promise):(e.get("/api/social/apis",{cache:!0}).success(function(e){p=e.facebookAppId,m=e.facebookPermissions,angular.isDefined(d)?a.resolve():(window.fbAsyncInit=function(){window.FB.init({appId:p,xfbml:!1,version:"v2.2"}),a.resolve()},function(e,n,r){function t(){g=!1,a.reject()}var o,i=e.getElementsByTagName(n)[0];e.getElementById(r)||(o=e.createElement(n),o.id=r,o.src="//connect.facebook.net/en_US/sdk.js",o.onerror=t,i.parentNode.insertBefore(o,i))}(document,"script","facebook-jssdk")),g=!0}).error(function(){n.path("/error"),a.reject()}),a.promise)}function i(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(f=n.authResponse,e.resolve({auto:!0,permissions:m})):e.reject()};angular.isDefined(d)?d.login(m.split(",")).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.login(n,{scope:m})}catch(r){console.error(JSON.stringify(r)),e.reject()}}function s(e){var n=function(n){if(angular.isDefined(n)&&!angular.isDefined(n.error)){var r=m.split(","),a=!0;angular.forEach(r,function(e){var r=!1;angular.forEach(n.data,function(n){e!==n.permission||"granted"!==n.status&&"declined"!==n.status||(r=!0)}),r||(a=!1)}),a?e.resolve({auto:!0,permissions:m}):e.reject()}else e.reject()},r="/me/permissions";angular.isDefined(d)?d.api(r,[]).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.api(r,n)}function c(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(f=n.authResponse,s(e)):e.reject()};angular.isDefined(d)?d.getLoginStatus().then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):window.FB.getLoginStatus(n)}catch(r){console.error(JSON.stringify(r)),e.reject()}}function u(e,n,r){var a=!0,t="";angular.forEach(e,function(e){a?a=!1:t+=", ",t+=e});var o=function(e){console.info(JSON.stringify(e)),r.resolve(e)},i={method:"apprequests",message:n,to:t};angular.isDefined(d)?d.showDialog(i).then(o,function(){r.reject()}):window.FB.ui(i,o)}function l(e,n){if("facebook"===e.source)try{var r=function(r){"connected"===r.status?(f=r.authResponse,n.resolve(r.authResponse.userID===e.sourceId)):n.resolve(!1)};angular.isDefined(d)?d.getLoginStatus().then(r,function(e){console.log(JSON.stringify(e)),n.resolve(!1)}):window.FB.getLoginStatus(r)}catch(a){console.error(JSON.stringify),n.resolve(!1)}else n.resolve(!1)}var f,d,g=!1,p="",m="";try{console.log(t.location.href),0===t.location.href.indexOf("file:")&&(d=a.get("$cordovaFacebook"))}catch(h){d=void 0}return{currentAuthorization:function(){return f},initiateFBLogin:function(){var e=r.defer();return o().then(function(){i(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=r.defer();return o().then(function(){c(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,n){var a=r.defer();return o().then(function(){u(e,n,a)},function(){a.reject()}),a.promise},playerAndFBMatch:function(e){var n=r.defer();return o().then(function(){l(e,n)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$location","$http","jtbLocalStorage","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q","$injector",function(e,n,r,a,t,o,i,s,c,u){function l(){return"gameCache-"+i.currentPlayer().md5}function f(){j.forEach(function(e){var n=$.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):$.put(e,{idMap:{},games:[]})})}function d(n){var r=0;for(var a in n.idMap)if(n.idMap.hasOwnProperty(a)){var t=n.games[n.idMap[a]],o=$.get(D),i=o.idMap[t.id];v(o,t,i),o=$.get(t.gamePhase),i=o.idMap[t.id],v(o,t,i),angular.isDefined(O)&&(o=$.get(O.getClassification(t)),i=o.idMap[t.id],v(o,t,i)),e.$broadcast("gameRemoved",t),++r}}function g(){t.setObject(l(),$.get(D).games)}function p(){var n=JSON.parse(JSON.stringify($.get(D)));a.get(i.currentPlayerBaseURL()+"/games").success(function(r){r.forEach(function(e){L.putUpdatedGame(e),angular.isDefined(n.idMap[e.id])&&delete n.idMap[e.id]}),d(n),g(),e.$broadcast("gameCachesLoaded",1)}).error(function(){r.path("/error")})}function m(){var n=t.getObject(l(),"[]");angular.forEach(n,function(e){L.putUpdatedGame(e)}),e.$broadcast("gameCachesLoaded",0)}function h(){var e=c.defer();return j.length>0?(f(),m(),e.resolve()):o.phases().then(function(n){j.slice(0),j.push(D),angular.forEach(n,function(e,n){j.push(n)}),angular.isDefined(O)&&angular.forEach(O.getClassifications(),function(e){j.push(e)}),f(),m(),e.resolve()},function(){r.path("/error"),e.reject()}),e.promise}function y(n,r){var a=$.get(n.gamePhase);a.games.push(n),a.idMap[n.id]=a.games.indexOf(n),angular.isDefined(O)&&(a=$.get(O.getClassification(n)),a.games.push(n),a.idMap[n.id]=a.games.indexOf(n)),r.games.push(n),r.idMap[n.id]=r.games.indexOf(n),e.$broadcast("gameAdded",n)}function v(e,n,r){delete e.idMap[n.id],e.games.splice(r,1);for(var a in e.idMap)if(e.idMap.hasOwnProperty(a)){var t=e.idMap[a];t>r&&(e.idMap[a]=t-1)}}function b(e,n,r,a){var t=$.get(e),o=t.idMap[n.id];if(e===r)t.games[o]=a;else{var i=$.get(r);i.idMap[a.id]=i.games.push(a)-1,v(t,n,o)}}function S(n,r,a,t){n.games[r]=a;var o=a.gamePhase,i=t.gamePhase;b(i,t,o,a),angular.isDefined(O)&&(o=O.getClassification(a),i=O.getClassification(t),b(i,t,o,a)),e.$broadcast("gameUpdated",t,a)}var D="All",$=n("game-gameCache"),j=[],L={},U="Have Live Game Feed "+s;console.info(U);var O;try{O=u.get("jtbGameClassifier")}catch(G){O=void 0}return L={putUpdatedGame:function(e){var n=$.get(D),r=n.idMap[e.id];if(angular.isDefined(r)){var a=n.games[r];if(e.lastUpdate<=a.lastUpdate)return console.info("Skipping Stale game update for "+e.id),void 0;S(n,r,e,a)}else y(e,n);g()},getGameForID:function(e){var n=$.get(D);if(angular.isDefined(n)){var r=n.idMap[e];if(angular.isDefined(r))return n.games[r]}},getGamesForPhase:function(e){var n=$.get(e);return angular.isDefined(n)?n.games:void 0},initialized:function(){return angular.isDefined($)&&angular.isDefined($.get(D))}},e.$on("gameUpdate",function(n,r,a){L.putUpdatedGame(a),e.$apply()}),e.$on("playerLoaded",function(){h()}),e.$on("liveFeedEstablished",function(){h().then(function(){p()})}),e.$on("refreshGames",function(){h().then(function(){p()})}),L}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(e,n,r){function a(){angular.isDefined(o)&&(r.cancel(o),o=void 0),angular.isDefined(i)&&(console.log("ending livefeedsubcription to "+n.currentID()),i.close()),i=void 0}function t(e){a(),angular.isUndefined(e)&&(e=0),console.log("depth is "+e),o=r(function(){if(""!==n.currentID()){c.url=s+"/livefeed/"+n.currentID();try{i=u.subscribe(c)}catch(a){console.log("sub ex "+JSON.stringify(a)),5>e?o=r(function(){t(e+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}var o,i,s="",c={url:"",contentType:"application/json",logLevel:"info",transport:"websocket",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,closeAsync:!0,onOpen:function(n){var a=this;r(function(){console.info(a.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")})},onMessage:function(n){var a=this,t=angular.copy(n);r(function(){angular.isDefined(t.messages)?t.messages.forEach(function(n){var r;try{r=JSON.parse(n)}catch(a){return console.error("got non-parseable message"),void 0}if(angular.isDefined(r.messageType)){switch(r.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",r.game.id,r.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(r.message)),void 0;case"Player":return e.$broadcast("playerUpdate",r.player.id,r.player),void 0}console.warn("onMessage: unknown message type '"+r.messageType+"'")}console.warn("unknown message structure "+r)}):console.warn(a.url+" unknown onMessage: "+JSON.stringify(t))})},onClose:function(e){var n=this;r(function(){console.warn(n.url+" closed: "+JSON.stringify(e))})},onError:function(e){var n=this;r(function(){console.error(n.url+" onError: "+JSON.stringify(e))})}},u=atmosphere;return e.$on("playerLoaded",function(){t()}),""!==n.currentID()&&t(),{suspendFeed:function(){a()},setEndPoint:function(e){s=e,"http://localhost:9998"===s&&(c.transport="long-polling"),t()}}}]),angular.module("coreGamesUi.services").factory("jtbLocalStorage",["$window",function(e){return{set:function(n,r){e.localStorage[n]=r},get:function(n,r){return e.localStorage[n]||r},setObject:function(n,r){e.localStorage[n]=JSON.stringify(r)},getObject:function(n,r){return JSON.parse(e.localStorage[n]||r||"{}")}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$location","$window","jtbFacebook",function(e,n,r,a,t){function o(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function i(){e.get("/api/security",{cache:!0}).success(function(e){switch(s=e,c=s.id,u=s.id,s.source){case"facebook":t.playerAndFBMatch(s).then(function(e){e?o():d.signOutAndRedirect()},function(){d.signOutAndRedirect()});break;default:o()}}).error(function(){r.path("/error")})}var s,c="",u="",l="/api/player",f="/friends",d={};return d={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).success(function(e){u=e.id,s=e,o()}).error(function(){r.path("/error")})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return l},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+f).then(function(e){return e.data})},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){a.location="#/signin"}).error(function(){a.location="#/signin"})}},n.$on("login",function(){console.log("login received"),i()}),n.$on("playerUpdate",function(e,r,a){u===r&&(angular.copy(a,s),n.$apply())}),d}]);