!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi",["coreGamesUi.controllers","coreGamesUi.config","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.services","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreInviteCtrl",["$modalInstance","$scope","invitableFriends","message","jtbFacebook",function(e,n,i,o,a){n.invitableFriends=i,n.chosenFriends=[],n.message=o,n.invite=function(){var i=[];angular.forEach(n.chosenFriends,function(e){i.push(e.id)}),a.inviteFriends(i,o),e.close()},n.cancel=function(){e.dismiss()}}]),angular.module("coreGamesUi.controllers").controller("CoreSignInCtrl",["$scope","$window","$cookies","jtbFacebook",function(e,n,i,o){function a(){e.showFacebook=!0,e.showManual=n.location.href.indexOf("localhost")>-1||n.location.href.indexOf("-dev")>-1,e.message=""}function t(){e.showFacebook=!1,e.showManual=!1,e.message="Logging in via Facebook",n.location="/auth/facebook"}e.message="Initializing...",e.showFacebook=!1,e.showManual=!1,e.csrf=i["XSRF-TOKEN"],e.fbLogin=function(){o.initiateFBLogin().then(function(e){e.auto?t():a()},function(){a()})},o.canAutoSignIn().then(function(e){e.auto?t():a()},function(){a()})}]),angular.module("coreGamesUi.directives").directive("disableAnimation",function(e){return{restrict:"A",link:function(n,i,o){o.$observe("disableAnimation",function(n){e.enabled(!n,i)})}}}),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var i=[];return angular.isArray(e)?e.forEach(function(e){for(var o=!1,a=Object.keys(n),t=0;t<a.length;t++){var r=a[t],s=n[r].toLowerCase();if(-1!==e[r].toString().toLowerCase().indexOf(s)){o=!0;break}}o&&i.push(e)}):i=e,i}}),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$location","$q","$injector","$window",function(e,n,i,o,a){function t(){var o=i.defer();return g?(o.resolve(),o.promise):(e.get("/api/social/apis",{cache:!0}).success(function(e){p=e.facebookAppId,m=e.facebookPermissions,angular.isDefined(d)?o.resolve():(window.fbAsyncInit=function(){FB.init({appId:p,xfbml:!1,version:"v2.2"}),o.resolve()},function(e,n,i){function a(){g=!1,o.reject()}var t,r=e.getElementsByTagName(n)[0];e.getElementById(i)||(t=e.createElement(n),t.id=i,t.src="//connect.facebook.net/en_US/sdk.js",t.onerror=a,r.parentNode.insertBefore(t,r))}(document,"script","facebook-jssdk")),g=!0}).error(function(){n.path("/error"),o.reject()}),o.promise)}function r(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,e.resolve({auto:!0,permissions:m})):e.reject()};angular.isDefined(d)?d.login(m.split(",")).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.login(n,{scope:m})}catch(i){console.error(JSON.stringify(i)),e.reject()}}function s(e){var n=function(n){if(angular.isDefined(n)&&!angular.isDefined(n.error)){var i=m.split(","),o=!0;angular.forEach(i,function(e){var i=!1;angular.forEach(n.data,function(n){e!==n.permission||"granted"!==n.status&&"declined"!==n.status||(i=!0)}),i||(o=!1)}),o?e.resolve({auto:!0,permissions:m}):e.reject()}else e.reject()},i="/me/permissions";angular.isDefined(d)?d.api(i,[]).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.api(i,n)}function c(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,s(e)):e.reject()};angular.isDefined(d)?d.getLoginStatus().then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.getLoginStatus(n)}catch(i){console.error(JSON.stringify(i)),e.reject()}}function u(e,n){var i=!0,o="";angular.forEach(e,function(e){i?i=!1:o+=", ",o+=e});var a=function(e){console.info(JSON.stringify(e))},t={method:"apprequests",message:n,to:o};angular.isDefined(d)?d.showDialog(t).then(a,function(){}):FB.ui(t,a)}function f(e,n){if("facebook"===e.source)try{var i=function(i){"connected"===i.status?(l=i.authResponse,n.resolve(i.authResponse.userID===e.sourceId)):n.resolve(!1)};angular.isDefined(d)?d.getLoginStatus().then(i,function(e){console.log(JSON.stringify(e)),n.resolve(!1)}):FB.getLoginStatus(i)}catch(o){console.error(JSON.stringify),n.resolve(!1)}else n.resolve(!1)}var l,d,g=!1,p="",m="";try{0===a.location.href.indexOf("file:")&&(d=o.get("$cordovaFacebook"))}catch(h){d=void 0}return{currentAuthorization:function(){return l},initiateFBLogin:function(){var e=i.defer();return t().then(function(){r(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=i.defer();return t().then(function(){c(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,n){t().then(function(){u(e,n)},function(){})},playerAndFBMatch:function(e){var n=i.defer();return t().then(function(){f(e,n)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$location","$http","jtbLocalStorage","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q","$injector",function(e,n,i,o,a,t,r,s,c,u){function f(){$.forEach(function(e){var n=S.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):S.put(e,{idMap:{},games:[]})})}function l(n){var i=0;for(var o in n.idMap)if(n.idMap.hasOwnProperty(o)){var a=n.games[n.idMap[o]],t=S.get(b),r=t.idMap[a.id];angular.isDefined(r)&&h(t,a,r),t=S.get(a.gamePhase),r=t.idMap[a.id],angular.isDefined(r)&&h(t,a,r),angular.isDefined(j)&&(t=S.get(j.getClassification(a)),r=t.idMap[a.id],angular.isDefined(r)&&h(t,a,r)),e.$broadcast("gameRemoved",a),++i}}function d(){var n=JSON.parse(JSON.stringify(S.get(b)));console.log(JSON.stringify(n)),o.get(r.currentPlayerBaseURL()+"/games").success(function(i){var o=0;i.forEach(function(e){O.putUpdatedGame(e),angular.isDefined(n.idMap[e.id])&&delete n.idMap[e.id]}),++o,l(n),e.$broadcast("gameCachesLoaded",o)}).error(function(){i.path("/error")})}function g(){var e=a.getObject("gameCache-"+r.currentPlayer().md5,"[]");angular.forEach(e,function(e){O.putUpdatedGame(e)})}function p(){var e=c.defer();return $.length>0?(f(),g(),e.resolve()):t.phases().then(function(n){$.slice(0),$.push(b),angular.forEach(n,function(e,n){$.push(n)}),angular.isDefined(j)&&angular.forEach(j.getClassifications(),function(e){$.push(e)}),f(),g(),e.resolve()},function(){i.path("/error"),e.reject()}),e.promise}function m(n,i){var o=S.get(n.gamePhase);o.games.push(n),o.idMap[n.id]=o.games.indexOf(n),angular.isDefined(j)&&(o=S.get(j.getClassification(n)),o.games.push(n),o.idMap[n.id]=o.games.indexOf(n)),i.games.push(n),i.idMap[n.id]=i.games.indexOf(n),e.$broadcast("gameAdded",n)}function h(e,n,i){delete e.idMap[n.id],e.games.splice(i,1);for(var o in e.idMap)if(e.idMap.hasOwnProperty(o)){var a=e.idMap[o];a>i&&(e.idMap[o]=a-1)}}function v(e,n,i,o){var a=S.get(e),t=a.idMap[n.id];if(e===i)a.games[t]=o;else{var r=S.get(i);r.idMap[o.id]=r.games.push(o)-1,h(a,n,t)}}function y(n,i,o,a){n.games[i]=o;var t=o.gamePhase,r=a.gamePhase;v(r,a,t,o),angular.isDefined(j)&&(t=j.getClassification(o),r=j.getClassification(a),v(r,a,t,o)),e.$broadcast("gameUpdated",a,o)}var b="All",S=n("game-gameCache"),$=[],D="Have Live Game Feed "+s;console.info(D);var j;try{j=u.get("jtbGameClassifier")}catch(G){j=void 0}var O={putUpdatedGame:function(e){var n=S.get(b),i=n.idMap[e.id];if(angular.isDefined(i)){var o=n.games[i];if(e.lastUpdate<=o.lastUpdate)return console.info("Skipping Stale game update for "+e.id),void 0;y(n,i,e,o)}else m(e,n)},getGameForID:function(e){var n=S.get(b);if(angular.isDefined(n)){var i=n.idMap[e];if(angular.isDefined(i))return n.games[i]}},getGamesForPhase:function(e){var n=S.get(e);return angular.isDefined(n)?n.games:void 0},initialized:function(){return angular.isDefined(S)&&angular.isDefined(S.get(b))}};return e.$on("gameUpdate",function(n,i,o){O.putUpdatedGame(o),e.$apply()}),e.$on("playerLoaded",function(){p()}),e.$on("liveFeedEstablished",function(){d()}),e.$on("refreshGames",function(){d()}),O}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(e,n,i){function o(){angular.isDefined(t)&&(i.cancel(t),t=void 0),angular.isDefined(r)&&(console.log("ending livefeedsubcription to "+n.currentID()),r.close()),r=void 0}function a(e){o(),angular.isUndefined(e)&&(e=0),t=i(function(){if(""!==n.currentID()){c.url=s+"/livefeed/"+n.currentID();try{r=u.subscribe(c)}catch(o){console.log(JSON.stringify(o)),5>e?t=i(function(){a(e+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}var t,r,s="",c={url:"",contentType:"application/json",logLevel:"info",transport:"long-polling",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,closeAsync:!0,onOpen:function(n){i(function(){console.info(this.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")})},onMessage:function(n){i(function(){angular.isDefined(n.messages)?n.messages.forEach(function(n){var i;try{i=JSON.parse(n)}catch(o){return console.error("got non-parseable message"),void 0}if(angular.isDefined(i.messageType)){switch(i.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",i.game.id,i.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(i.message)),void 0;case"Player":return e.$broadcast("playerUpdate",i.player.id,i.player),void 0;default:console.warn("onMessage: unknown message type '"+i.messageType+"'")}console.warn("onMessage: unknown message type '"+i.messageType+"'")}console.warn("unknown message structure "+i)}):console.warn(this.url+" unknown onMessage: "+JSON.stringify(n))})},onClose:function(e){i(function(){console.warn(this.url+" closed: "+JSON.stringify(e))})},onError:function(e){i(function(){console.error(this.url+" onError: "+JSON.stringify(e))})}},u=atmosphere;return e.$on("playerLoaded",function(){a()}),""!==n.currentID()&&a(),{suspendFeed:function(){o()},setEndPoint:function(e){s=e},handler:function(){return c}}}]),angular.module("coreGamesUi.services").factory("jtbLocalStorage",["$window",function(e){return{set:function(n,i){e.localStorage[n]=i},get:function(n,i){return e.localStorage[n]||i},setObject:function(n,i){e.localStorage[n]=JSON.stringify(i)},getObject:function(n,i){return JSON.parse(e.localStorage[n]||i||"{}")}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$location","$window","jtbFacebook",function(e,n,i,o,a){function t(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function r(){e.get("/api/security",{cache:!0}).success(function(e){switch(s=e,c=s.id,u=s.id,s.source){case"facebook":a.playerAndFBMatch(s).then(function(e){e?t():d.signOutAndRedirect()},function(){d.signOutAndRedirect()});break;default:t()}}).error(function(){i.path("/error")})}var s,c="",u="",f="/api/player",l="/friends",d={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).success(function(e){u=e.id,s=e,t()}).error(function(){i.path("/error")})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return f},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+l).then(function(e){return e.data})},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){o.location="#/signin"}).error(function(){o.location="#/signin"})}};return n.$on("login",function(){console.log("login received"),r()}),n.$on("playerUpdate",function(e,i,o){u===i&&(angular.copy(o,s),n.$apply())}),d}]);