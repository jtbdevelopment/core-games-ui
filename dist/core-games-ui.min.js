!function(e){e.module("coreGamesUi.config",[]).value("coreGamesUi.config",{debug:!0}),e.module("coreGamesUi.controllers",[]),e.module("coreGamesUi.directives",[]),e.module("coreGamesUi.filters",[]),e.module("coreGamesUi.services",[]),e.module("coreGamesUi.interceptors",[]),e.module("coreGamesUi",["coreGamesUi.config","coreGamesUi.interceptors","coreGamesUi.services","coreGamesUi.directives","coreGamesUi.filters","coreGamesUi.controllers","ngResource","ngCookies","ngSanitize"])}(angular),angular.module("coreGamesUi.controllers").controller("CoreInviteCtrl",["$modalInstance","$scope","invitableFriends","message","jtbFacebook",function(e,n,t,r,o){n.invitableFriends=t,n.chosenFriends=[],n.message=r,n.invite=function(){var t=[];angular.forEach(n.chosenFriends,function(e){t.push(e.id)}),o.inviteFriends(t,r),e.close()},n.cancel=function(){e.dismiss()}}]),angular.module("coreGamesUi.controllers").controller("CoreSignInCtrl",["$scope","$window","$cookies","jtbFacebook",function(e,n,t,r){function o(){e.showFacebook=!0,e.showManual=n.location.href.indexOf("localhost")>-1||n.location.href.indexOf("-dev")>-1,e.message=""}function a(){e.showFacebook=!1,e.showManual=!1,e.message="Logging in via Facebook",n.location="/auth/facebook"}e.message="Initializing...",e.showFacebook=!1,e.showManual=!1,e.csrf=t["XSRF-TOKEN"],e.fbLogin=function(){r.initiateFBLogin().then(function(e){e.auto?a():o()},function(){o()})},r.canAutoSignIn().then(function(e){e.auto?a():o()},function(){o()})}]),angular.module("coreGamesUi.directives").directive("disableAnimation",function(e){return{restrict:"A",link:function(n,t,r){r.$observe("disableAnimation",function(n){e.enabled(!n,t)})}}}),angular.module("coreGamesUi.filters").filter("propsFilter",function(){return function(e,n){var t=[];return angular.isArray(e)?e.forEach(function(e){for(var r=!1,o=Object.keys(n),a=0;a<o.length;a++){var i=o[a],s=n[i].toLowerCase();if(-1!==e[i].toString().toLowerCase().indexOf(s)){r=!0;break}}r&&t.push(e)}):t=e,t}}),angular.module("coreGamesUi.interceptors").factory("jtbCSRFHttpInterceptor",function(){var e;return{request:function(n){return angular.isDefined(e)&&(n.headers["X-XSRF-TOKEN"]=e),n},response:function(n){return angular.isDefined(n.headers)&&angular.isDefined(n.headers("XSRF-TOKEN"))&&null!==n.headers("XSRF-TOKEN")&&(e=n.headers("XSRF-TOKEN")),n}}}).config(["$httpProvider",function(e){e.interceptors.push("jtbCSRFHttpInterceptor")}]),angular.module("coreGamesUi.interceptors").factory("jtbUnauthorizedHandler",["$q","$rootScope",function(e,n){return{responseError:function(t){return console.log("responseError:"+JSON.stringify(t)),401===t.status&&n.$broadcast("InvalidSession"),e.reject(t)}}}]).config(["$httpProvider",function(e){e.interceptors.push("jtbUnauthorizedHandler")}]),angular.module("coreGamesUi.services").factory("jtbFacebook",["$http","$location","$q","$injector","$window",function(e,n,t,r,o){function a(){var r=t.defer();return g?(r.resolve(),r.promise):(e.get("/api/social/apis",{cache:!0}).success(function(e){p=e.facebookAppId,m=e.facebookPermissions,angular.isDefined(d)?r.resolve():(window.fbAsyncInit=function(){FB.init({appId:p,xfbml:!1,version:"v2.2"}),r.resolve()},function(e,n,t){function o(){g=!1,r.reject()}var a,i=e.getElementsByTagName(n)[0];e.getElementById(t)||(a=e.createElement(n),a.id=t,a.src="//connect.facebook.net/en_US/sdk.js",a.onerror=o,i.parentNode.insertBefore(a,i))}(document,"script","facebook-jssdk")),g=!0}).error(function(){n.path("/error"),r.reject()}),r.promise)}function i(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,e.resolve({auto:!0,permissions:m})):e.reject()};angular.isDefined(d)?d.login(m.split(",")).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.login(n,{scope:m})}catch(t){console.error(JSON.stringify(t)),e.reject()}}function s(e){var n=function(n){if(angular.isDefined(n)&&!angular.isDefined(n.error)){var t=m.split(","),r=!0;angular.forEach(t,function(e){var t=!1;angular.forEach(n.data,function(n){e!==n.permission||"granted"!==n.status&&"declined"!==n.status||(t=!0)}),t||(r=!1)}),r?e.resolve({auto:!0,permissions:m}):e.reject()}else e.reject()},t="/me/permissions";angular.isDefined(d)?d.api(t,[]).then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.api(t,n)}function c(e){try{var n=function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&"connected"===n.status?(l=n.authResponse,s(e)):e.reject()};angular.isDefined(d)?d.getLoginStatus().then(n,function(n){console.log(JSON.stringify(n)),e.reject()}):FB.getLoginStatus(n)}catch(t){console.error(JSON.stringify(t)),e.reject()}}function u(e,n,t){var r=!0,o="";angular.forEach(e,function(e){r?r=!1:o+=", ",o+=e});var a=function(e){console.info(JSON.stringify(e)),t.resolve(e)},i={method:"apprequests",message:n,to:o};angular.isDefined(d)?d.showDialog(i).then(a,function(){t.reject()}):FB.ui(i,a)}function f(e,n){if("facebook"===e.source)try{var t=function(t){"connected"===t.status?(l=t.authResponse,n.resolve(t.authResponse.userID===e.sourceId)):n.resolve(!1)};angular.isDefined(d)?d.getLoginStatus().then(t,function(e){console.log(JSON.stringify(e)),n.resolve(!1)}):FB.getLoginStatus(t)}catch(r){console.error(JSON.stringify),n.resolve(!1)}else n.resolve(!1)}var l,d,g=!1,p="",m="";try{console.log(o.location.href),0===o.location.href.indexOf("file:")&&(d=r.get("$cordovaFacebook"))}catch(h){d=void 0}return{currentAuthorization:function(){return l},initiateFBLogin:function(){var e=t.defer();return a().then(function(){i(e)},function(){e.reject()}),e.promise},canAutoSignIn:function(){var e=t.defer();return a().then(function(){c(e)},function(){e.reject()}),e.promise},inviteFriends:function(e,n){var r=t.defer();return a().then(function(){u(e,n,r)},function(){r.reject()}),r.promise},playerAndFBMatch:function(e){var n=t.defer();return a().then(function(){f(e,n)}),n.promise}}}]),angular.module("coreGamesUi.services").factory("jtbGameCache",["$rootScope","$cacheFactory","$location","$http","jtbLocalStorage","jtbGamePhaseService","jtbPlayerService","jtbLiveGameFeed","$q","$injector",function(e,n,t,r,o,a,i,s,c,u){function f(){return"gameCache-"+i.currentPlayer().md5}function l(){U.forEach(function(e){var n=j.get(e);angular.isDefined(n)?(Object.keys(n.idMap).forEach(function(e){delete n.idMap[e]}),n.games.splice(0)):j.put(e,{idMap:{},games:[]})})}function d(n){var t=0;for(var r in n.idMap)if(n.idMap.hasOwnProperty(r)){var o=n.games[n.idMap[r]],a=j.get($),i=a.idMap[o.id];b(a,o,i),a=j.get(o.gamePhase),i=a.idMap[o.id],b(a,o,i),angular.isDefined(F)&&(a=j.get(F.getClassification(o)),i=a.idMap[o.id],b(a,o,i)),e.$broadcast("gameRemoved",o),++t}}function g(){o.setObject(f(),j.get($).games)}function p(){var n=JSON.parse(JSON.stringify(j.get($)));r.get(i.currentPlayerBaseURL()+"/games").success(function(t){t.forEach(function(e){D.putUpdatedGame(e),angular.isDefined(n.idMap[e.id])&&delete n.idMap[e.id]}),d(n),g(),e.$broadcast("gameCachesLoaded",1)}).error(function(){t.path("/error")})}function m(){var n=o.getObject(f(),"[]");angular.forEach(n,function(e){D.putUpdatedGame(e)}),e.$broadcast("gameCachesLoaded",0)}function h(){var e=c.defer();return U.length>0?(l(),m(),e.resolve()):a.phases().then(function(n){U.slice(0),U.push($),angular.forEach(n,function(e,n){U.push(n)}),angular.isDefined(F)&&angular.forEach(F.getClassifications(),function(e){U.push(e)}),l(),m(),e.resolve()},function(){t.path("/error"),e.reject()}),e.promise}function v(n,t){var r=j.get(n.gamePhase);r.games.push(n),r.idMap[n.id]=r.games.indexOf(n),angular.isDefined(F)&&(r=j.get(F.getClassification(n)),r.games.push(n),r.idMap[n.id]=r.games.indexOf(n)),t.games.push(n),t.idMap[n.id]=t.games.indexOf(n),e.$broadcast("gameAdded",n)}function b(e,n,t){delete e.idMap[n.id],e.games.splice(t,1);for(var r in e.idMap)if(e.idMap.hasOwnProperty(r)){var o=e.idMap[r];o>t&&(e.idMap[r]=o-1)}}function y(e,n,t,r){var o=j.get(e),a=o.idMap[n.id];if(e===t)o.games[a]=r;else{var i=j.get(t);i.idMap[r.id]=i.games.push(r)-1,b(o,n,a)}}function S(n,t,r,o){n.games[t]=r;var a=r.gamePhase,i=o.gamePhase;y(i,o,a,r),angular.isDefined(F)&&(a=F.getClassification(r),i=F.getClassification(o),y(i,o,a,r)),e.$broadcast("gameUpdated",o,r)}var $="All",j=n("game-gameCache"),U=[],O="Have Live Game Feed "+s;console.info(O);var F;try{F=u.get("jtbGameClassifier")}catch(G){F=void 0}var D={putUpdatedGame:function(e){var n=j.get($),t=n.idMap[e.id];if(angular.isDefined(t)){var r=n.games[t];if(e.lastUpdate<=r.lastUpdate)return console.info("Skipping Stale game update for "+e.id),void 0;S(n,t,e,r)}else v(e,n);g()},getGameForID:function(e){var n=j.get($);if(angular.isDefined(n)){var t=n.idMap[e];if(angular.isDefined(t))return n.games[t]}},getGamesForPhase:function(e){var n=j.get(e);return angular.isDefined(n)?n.games:void 0},initialized:function(){return angular.isDefined(j)&&angular.isDefined(j.get($))}};return e.$on("gameUpdate",function(n,t,r){D.putUpdatedGame(r),e.$apply()}),e.$on("playerLoaded",function(){h()}),e.$on("liveFeedEstablished",function(){h().then(function(){p()})}),e.$on("refreshGames",function(){h().then(function(){p()})}),D}]),angular.module("coreGamesUi.services").factory("jtbGameFeatureService",["$http",function(e){return{features:function(){return e.get("/api/features",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbGamePhaseService",["$http",function(e){return{phases:function(){return e.get("/api/phases",{cache:!0}).then(function(e){return e.data})}}}]),angular.module("coreGamesUi.services").factory("jtbLiveGameFeed",["$rootScope","jtbPlayerService","$timeout",function(e,n,t){function r(){angular.isDefined(a)&&(t.cancel(a),a=void 0),angular.isDefined(i)&&(console.log("ending livefeedsubcription to "+n.currentID()),i.close()),i=void 0}function o(e){r(),angular.isUndefined(e)&&(e=0),console.log("depth is "+e),a=t(function(){if(""!==n.currentID()){c.url=s+"/livefeed/"+n.currentID();try{i=u.subscribe(c)}catch(r){console.log("sub ex "+JSON.stringify(r)),5>e?a=t(function(){o(e+1)},500):console.warn("Gave up trying to subscribe to websocket")}}},1e3)}var a,i,s="",c={url:"",contentType:"application/json",logLevel:"info",transport:"websocket",trackMessageLength:!0,fallbackTransport:"long-polling",withCredentials:!0,handleOnlineOffline:!1,closeAsync:!0,onOpen:function(n){var r=this;t(function(){console.info(r.url+" Atmosphere connected using "+n.transport),e.$broadcast("liveFeedEstablished")})},onMessage:function(n){var r=this,o=angular.copy(n);t(function(){angular.isDefined(o.messages)?o.messages.forEach(function(n){var t;try{t=JSON.parse(n)}catch(r){return console.error("got non-parseable message"),void 0}if(angular.isDefined(t.messageType)){switch(t.messageType.toString()){case"Game":return e.$broadcast("gameUpdate",t.game.id,t.game),void 0;case"Heartbeat":return console.info("got a heartbeat "+JSON.stringify(t.message)),void 0;case"Player":return e.$broadcast("playerUpdate",t.player.id,t.player),void 0}console.warn("onMessage: unknown message type '"+t.messageType+"'")}console.warn("unknown message structure "+t)}):console.warn(r.url+" unknown onMessage: "+JSON.stringify(o))})},onClose:function(e){var n=this;t(function(){console.warn(n.url+" closed: "+JSON.stringify(e))})},onError:function(e){var n=this;t(function(){console.error(n.url+" onError: "+JSON.stringify(e))})}},u=atmosphere;return e.$on("playerLoaded",function(){o()}),""!==n.currentID()&&o(),{suspendFeed:function(){r()},setEndPoint:function(e){s=e,"http://localhost:9998"===s&&(c.transport="long-polling"),o()}}}]),angular.module("coreGamesUi.services").factory("jtbLocalStorage",["$window",function(e){return{set:function(n,t){e.localStorage[n]=t},get:function(n,t){return e.localStorage[n]||t},setObject:function(n,t){e.localStorage[n]=JSON.stringify(t)},getObject:function(n,t){return JSON.parse(e.localStorage[n]||t||"{}")}}}]),angular.module("coreGamesUi.services").factory("jtbPlayerService",["$http","$rootScope","$location","$window","jtbFacebook",function(e,n,t,r,o){function a(){console.log("Broadcasting playerLoad"),n.$broadcast("playerLoaded")}function i(){e.get("/api/security",{cache:!0}).success(function(e){switch(s=e,c=s.id,u=s.id,s.source){case"facebook":o.playerAndFBMatch(s).then(function(e){e?a():d.signOutAndRedirect()},function(){d.signOutAndRedirect()});break;default:a()}}).error(function(){t.path("/error")})}var s,c="",u="",f="/api/player",l="/friends",d={overridePID:function(n){e.put(this.currentPlayerBaseURL()+"/admin/"+n).success(function(e){u=e.id,s=e,a()}).error(function(){t.path("/error")})},realPID:function(){return c},currentID:function(){return u},currentPlayerBaseURL:function(){return f},currentPlayerFriends:function(){return e.get(this.currentPlayerBaseURL()+l).then(function(e){return e.data})},currentPlayer:function(){return s},signOutAndRedirect:function(){e.post("/signout").success(function(){r.location="#/signin"}).error(function(){r.location="#/signin"})}};return n.$on("login",function(){console.log("login received"),i()}),n.$on("playerUpdate",function(e,t,r){u===t&&(angular.copy(r,s),n.$apply())}),d}]);